<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Anal√≠tico</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-body: #f0f2f5; --bg-card: #ffffff; --text-main: #333333; --text-muted: #6c757d; --border-color: #e0e0e0; --card-shadow: 0 2px 4px rgba(0,0,0,0.05); --navbar-bg: #ffffff; --header-bg: #f8f9fa; }
        [data-theme="dark"] { --bg-body: #212529; --bg-card: #2c3034; --text-main: #f8f9fa; --text-muted: #adb5bd; --border-color: #373b3e; --card-shadow: 0 4px 6px rgba(0,0,0,0.3); --navbar-bg: #2c3034; --header-bg: #343a40; }
        
        body { background-color: var(--bg-body); font-family: 'Roboto', sans-serif; color: var(--text-main); transition: 0.3s; visibility: hidden; }
        
        .navbar { background: var(--navbar-bg); box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-bottom: 1px solid var(--border-color); z-index: 1000; }
        .filter-bar { background: var(--bg-card); padding: 15px 20px; border-radius: 8px; box-shadow: var(--card-shadow); margin-bottom: 20px; border: 1px solid var(--border-color); }
        .filter-label { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; display: block; }
        
        .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .kpi-card { color: #fff !important; border-radius: 8px; padding: 15px; position: relative; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: grab; border: none; min-height: 100px; }
        .kpi-card:active { cursor: grabbing; }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .kpi-card .kpi-title { font-size: 0.9rem; font-weight: 500; opacity: 0.9; margin-bottom: 5px; position: relative; z-index: 2; padding-right: 20px; }
        .kpi-card .kpi-value { font-size: 2.2rem; font-weight: 700; line-height: 1.1; position: relative; z-index: 2; }
        .kpi-card .kpi-icon { position: absolute; right: 10px; bottom: 10px; font-size: 3.5rem; opacity: 0.2; z-index: 1; pointer-events: none; }
        .kpi-edit-btn { position: absolute; top: 8px; right: 8px; z-index: 10; background: rgba(255,255,255,0.2); border: none; color: #fff; width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s, background 0.2s; cursor: pointer; }
        .kpi-card:hover .kpi-edit-btn { opacity: 1; }
        .kpi-edit-btn:hover { background: rgba(255,255,255,0.4); }

        .chart-wrapper { transition: all 0.3s ease; }
        .chart-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--card-shadow); margin-bottom: 20px; overflow: hidden; height: 100%; display: flex; flex-direction: column; }
        .chart-header { background-color: var(--header-bg); padding: 10px 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; cursor: move; }
        .chart-title { font-size: 1rem; font-weight: 600; color: var(--text-main); margin: 0; }
        .chart-body { padding: 15px; flex-grow: 1; position: relative; min-height: 300px; }
        .chart-actions .btn { padding: 2px 6px; font-size: 0.8rem; color: var(--text-muted); }
        .chart-card.minimized .chart-body { display: none; min-height: 0; }

        .btn-outline-secondary { color: var(--text-main); border-color: var(--text-muted); }
        .btn-outline-secondary:hover { background-color: var(--text-muted); color: #fff; }
        
        #colorMappingArea { max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light sticky-top px-4">
        <div class="container-fluid">
            <a href="index.html" class="btn btn-sm btn-outline-secondary me-3 d-flex align-items-center gap-2 fw-bold"><i class="bi bi-arrow-left"></i> Voltar</a>
            <a class="navbar-brand d-flex align-items-center gap-2" href="#"><i class="bi bi-speedometer2"></i> Painel de Controle</a>
            <div class="ms-auto d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-outline-success fw-bold" onclick="window.dashboard.openNewKPI()" title="Novo KPI"><i class="bi bi-plus-lg"></i> KPI</button>
                <button id="btnAddChart" class="btn btn-sm btn-success fw-bold" onclick="window.dashboard.openAddChartModal()"><i class="bi bi-plus-lg"></i> Gr√°fico</button>
                <span id="lastUpdate" class="small text-muted ms-2 d-none d-md-inline">...</span>
                <button class="btn btn-sm btn-outline-primary" onclick="window.location.reload()"><i class="bi bi-arrow-clockwise"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="import('./js/auth.js').then(m => m.AuthManager.logout())"><i class="bi bi-box-arrow-right"></i></button>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4 px-4">
        
        <div class="filter-bar">
            <div class="row g-3">
                <div class="col-md-2">
                    <label class="filter-label">N√≠vel (Escopo)</label>
                    <select id="filterScope" class="form-select form-select-sm" onchange="window.dashboard.applyFilters()">
                        <option value="all" selected>Todos (Pais + Filhos)</option>
                        <option value="parents">Apenas Pais</option>
                        <option value="children">Apenas Filhos</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="filter-label">Tipo de Arquivo</label>
                    <select id="filterTipoArq" class="form-select form-select-sm" onchange="window.dashboard.applyFilters()"><option value="">Todos</option></select>
                </div>
                <div class="col-md-3">
                    <label class="filter-label">Banco</label>
                    <select id="filterBanco" class="form-select form-select-sm" onchange="window.dashboard.applyFilters()"><option value="">Todos</option></select>
                </div>
                <div class="col-md-3">
                    <label class="filter-label">Empresa</label>
                    <select id="filterEmpresa" class="form-select form-select-sm" onchange="window.dashboard.applyFilters()"><option value="">Todas</option></select>
                </div>
                <div class="col-md-2">
                    <label class="filter-label">Respons√°vel</label>
                    <select id="filterResponsavel" class="form-select form-select-sm" onchange="window.dashboard.applyFilters()"><option value="">Todos</option></select>
                </div>
            </div>
        </div>

        <div id="kpiArea" class="kpi-container"></div>
        <div id="dynamicChartsArea" class="row g-4"></div>
    </div>

    <div class="modal fade" id="modalKPIConfig" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="modalKPITitle">Configurar Totalizador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="kpiIndex">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">T√≠tulo</label>
                        <input type="text" id="kpiTitle" class="form-control" placeholder="Ex: Processados com Sucesso">
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label small fw-bold">Cor de Fundo</label>
                            <input type="color" id="kpiColor" class="form-control form-control-color w-100" value="#283593">
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold">√çcone</label>
                            <select id="kpiIcon" class="form-select">
                                <option value="bi-credit-card">üí≥ Pagamento</option>
                                <option value="bi-cash-coin">üí∏ Recebimento</option>
                                <option value="bi-check-circle">‚úÖ Sucesso</option>
                                <option value="bi-exclamation-triangle">‚ö†Ô∏è Alerta</option>
                                <option value="bi-x-circle">‚ùå Erro</option>
                                <option value="bi-hourglass-split">‚è≥ Pendente</option>
                                <option value="bi-file-earmark-text">üìÑ Arquivo</option>
                                <option value="bi-graph-up">üìà Gr√°fico</option>
                                <option value="bi-people-fill">üë• Equipe</option>
                                <option value="bi-bank">üè¶ Banco</option>
                                <option value="bi-building">üè¢ Empresa</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Regra de Contagem</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <select id="kpiField" class="form-select form-select-sm">
                                    <option value="all">Total Geral</option>
                                    <option value="status">Status √©...</option>
                                    <option value="tipo_fluxo">Fluxo √©...</option>
                                    <option value="prioridade">Prioridade √©...</option>
                                    <option value="modalidade">Modalidade √©...</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <input type="text" id="kpiValue" class="form-control form-control-sm" placeholder="Valor (ex: Conclu√≠do)">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-danger" id="btnDeleteKPI" onclick="window.dashboard.deleteCurrentKPI()" style="display:none;">Excluir</button>
                    <div><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-success fw-bold" onclick="window.dashboard.saveKPIFromModal()">Salvar</button></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalChartConfig" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Configurar Gr√°fico</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="chartId">
                    <div class="mb-3"><label class="form-label small fw-bold">T√≠tulo</label><input type="text" id="chartTitleInput" class="form-control"></div>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><label class="form-label small fw-bold">Tipo</label><select id="chartTypeInput" class="form-select"><option value="bar">Barras Verticais</option><option value="horizontalBar">Barras Horizontais</option><option value="pie">Pizza</option><option value="doughnut">Rosca</option></select></div>
                        <div class="col-6"><label class="form-label small fw-bold">Largura</label><select id="chartWidthInput" class="form-select"><option value="col-md-4">1/3 Tela</option><option value="col-md-6">1/2 Tela</option><option value="col-md-8">2/3 Tela</option><option value="col-md-12">Tela Cheia</option></select></div>
                    </div>
                    <div class="mb-3"><label class="form-label small fw-bold">Campo de Dados</label><select id="chartFieldInput" class="form-select" onchange="window.dashboard.generateColorPickers(this.value)"><option value="status">Status</option><option value="modalidade">Modalidade</option><option value="ocorrencia">Ocorr√™ncia</option><option value="responsavel">Respons√°vel</option><option value="prioridade">Prioridade</option><option value="empresa">Empresa</option><option value="banco">Banco</option><option value="tipo_arq">Tipo Arquivo</option></select></div>
                    <div class="mb-3"><label class="form-label small fw-bold">Filtro Fixo</label><select id="chartFilterScope" class="form-select"><option value="">Nenhum</option><option value="Contas a Pagar">Apenas Contas a Pagar</option><option value="Contas a Receber">Apenas Contas a Receber</option></select></div>
                    <div class="mb-3"><label class="form-label small fw-bold">Cores</label><div id="colorMappingArea" class="small border p-2 rounded"></div></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" onclick="window.dashboard.saveChartConfig()">Salvar</button></div>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script type="module" src="js/dashboard.js"></script>
</body>
</html>